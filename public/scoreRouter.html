<!DOCTYPE html>

<html>
<head>
  <title>scoreRouter.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="gameController.html">
                gameController.js
              </a>
            
              
              <a class="source" href="playerController.html">
                playerController.js
              </a>
            
              
              <a class="source" href="scoreController.html">
                scoreController.js
              </a>
            
              
              <a class="source" href="gameRouter.html">
                gameRouter.js
              </a>
            
              
              <a class="source" href="scoreRouter.html">
                scoreRouter.js
              </a>
            
              
              <a class="source" href="scoringService.html">
                scoringService.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>scoreRouter.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> scoreResource = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>).Router(),
	mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>),
	Score = mongoose.model(<span class="hljs-string">'Score'</span>),
	scoreController = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../controllers/scoreController'</span>); 
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h3 id="get-scores-scoreid">GET: /scores/:scoreId</h3>
<p>This endpoint expects nothing but a valid scoreId in the request parameters. </p>
<pre><code class="lang-url">http://localhost:3000/scores/5447481b12d0a496dfa27bb5[?pretty=true]
</code></pre>
<p>In return you’ll receive a score object containing the score’s id, the player
object this score belongs to, the game id of the game this score belongs to, 
and a ‘rolls’ property.  The rolls property is an ordered integer array of all 
the pins knocked down per roll starting from the first roll, to the most recent.</p>
<pre><code class="lang-js">{
  <span class="hljs-string">"_id"</span>:<span class="hljs-string">"5447481b12d0a496dfa27bb5"</span>,
  <span class="hljs-string">"player"</span>:{
    <span class="hljs-string">"_id"</span>:<span class="hljs-string">"5445cf08faf619d8af4dc8bb"</span>,
    <span class="hljs-string">"name"</span>:<span class="hljs-string">"Carl"</span>,
    <span class="hljs-string">"__v"</span>:<span class="hljs-number">0</span>,
    <span class="hljs-string">"dateCreated"</span>:<span class="hljs-string">"2014-10-21T03:12:08.659Z"</span>
  },
  <span class="hljs-string">"game"</span>:<span class="hljs-string">"5447481b12d0a496dfa27bb3"</span>,
  <span class="hljs-string">"__v"</span>:<span class="hljs-number">1</span>,
  <span class="hljs-string">"dateCreated"</span>:<span class="hljs-string">"2014-10-22T06:00:59.483Z"</span>,
  <span class="hljs-string">"rolls"</span>:[ <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span> ]
}
</code></pre>
<p>Requesting with ?pretty=true will return you a formatted score object, with roll data
broken down into frames, and each containing a running score as the game progresses.</p>
<pre><code>{
  <span class="hljs-string">"playerName"</span>:<span class="hljs-string">"Carl"</span>,
  <span class="hljs-string">"frames"</span>:[
    {
      <span class="hljs-string">"firstRoll"</span>:<span class="hljs-string">"4"</span>,
      <span class="hljs-string">"secondRoll"</span>:<span class="hljs-string">"5"</span>,
      <span class="hljs-string">"score"</span>:<span class="hljs-number">9</span>
    },
    {
      <span class="hljs-string">"firstRoll"</span>:<span class="hljs-string">"X"</span>,
      <span class="hljs-string">"secondRoll"</span>:<span class="hljs-string">""</span>,
      <span class="hljs-string">"score"</span>:<span class="hljs-number">27</span>
    },
    {
      <span class="hljs-string">"firstRoll"</span>:<span class="hljs-string">"4"</span>,
      <span class="hljs-string">"secondRoll"</span>:<span class="hljs-string">"4"</span>,
      <span class="hljs-string">"score"</span>:<span class="hljs-number">35</span>
    },
    {
      <span class="hljs-string">"firstRoll"</span>:<span class="hljs-string">"5"</span>,
      <span class="hljs-string">"secondRoll"</span>:<span class="hljs-string">"/"</span>,
      <span class="hljs-string">"score"</span>:<span class="hljs-number">47</span>
    },
    {
      <span class="hljs-string">"firstRoll"</span>:<span class="hljs-string">"2"</span>,
      <span class="hljs-string">"secondRoll"</span>:<span class="hljs-string">"0"</span>,
      <span class="hljs-string">"score"</span>:<span class="hljs-number">49</span>
    }
  ]
}
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>	scoreResource.get(<span class="hljs-string">'/:scoreId'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span></span>{
		Score.findOne({_id : req.param(<span class="hljs-string">'scoreId'</span>)})
		.populate(<span class="hljs-string">'player'</span>)
		.exec(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, score)</span></span>{
			<span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">500</span>).json({err: err});
			<span class="hljs-keyword">if</span>(!score) <span class="hljs-keyword">return</span> res.sendStatus(<span class="hljs-number">404</span>);
			<span class="hljs-keyword">if</span>(req.query.pretty){
				<span class="hljs-keyword">var</span> prettyScore = {};
				prettyScore.playerName = score.player.name;
				prettyScore.frames = scoreController.getFrameByFrameScores(score.rolls); 
				<span class="hljs-keyword">return</span> res.send(<span class="hljs-built_in">JSON</span>.stringify(prettyScore, <span class="hljs-literal">null</span>, <span class="hljs-string">'\t'</span>));
			} 
			<span class="hljs-keyword">return</span> res.send(score.toJSON());
		});
	});</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h3 id="post-scores-scoreid">POST: /scores/:scoreId</h3>
<p>As of now, new score objects can’t be created outside of initial game creation. 
This endpoint instead expects a simple object containing a newRolls array in the
POST request.  This    newRolls array should consist of integers from ranging from 
0 - 10, ordered from oldest rolls to newest.</p>
<pre><code>{ <span class="hljs-string">"newRolls"</span>: [ <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span> ]}
</code></pre><p>Each new roll will be appended onto the end of rolls currently on the score and 
validated one at a time.  If any roll produces an invalid game state, the entirety
of the new data will be thrown away and a ‘bad request’ will be returned.</p>
<p>If all goes well, you’ll receive the new updated score object as a response.</p>
<pre><code class="lang-js">{
  <span class="hljs-string">"_id"</span>:<span class="hljs-string">"5447481b12d0a496dfa27bb5"</span>,
  <span class="hljs-string">"player"</span>:{
    <span class="hljs-string">"_id"</span>:<span class="hljs-string">"5445cf08faf619d8af4dc8bb"</span>,
    <span class="hljs-string">"name"</span>:<span class="hljs-string">"Carl"</span>,
    <span class="hljs-string">"__v"</span>:<span class="hljs-number">0</span>,
    <span class="hljs-string">"dateCreated"</span>:<span class="hljs-string">"2014-10-21T03:12:08.659Z"</span>
  },
  <span class="hljs-string">"game"</span>:<span class="hljs-string">"5447481b12d0a496dfa27bb3"</span>,
  <span class="hljs-string">"__v"</span>:<span class="hljs-number">1</span>,
  <span class="hljs-string">"dateCreated"</span>:<span class="hljs-string">"2014-10-22T06:00:59.483Z"</span>,
  <span class="hljs-string">"rolls"</span>:[ <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span> ]
}
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>	scoreResource.post(<span class="hljs-string">'/:scoreId'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, res, next)</span></span>{
		<span class="hljs-keyword">var</span> newRolls = req.body.newRolls;
		<span class="hljs-keyword">if</span>(!newRolls || !<span class="hljs-built_in">Array</span>.isArray(newRolls)) <span class="hljs-keyword">return</span> res.sendStatus(<span class="hljs-number">400</span>); 
		scoreController.appendNewRollsToScore(req.param(<span class="hljs-string">'scoreId'</span>), newRolls, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, updatedScore)</span></span>{
			<span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({err: err});
			<span class="hljs-keyword">if</span>(!updatedScore) <span class="hljs-keyword">return</span> res.sendStatus(<span class="hljs-number">404</span>); 

			<span class="hljs-keyword">return</span> res.status(<span class="hljs-number">200</span>).send(updatedScore.toJSON()); 
		});
	});
	<span class="hljs-keyword">return</span> scoreResource;   	
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
